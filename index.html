<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>SunYun's Mini Neurosynth Explorer</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-black text-gray-100 min-h-screen flex flex-col font-sans">
  <!-- Header -->
  <header class="bg-gray-900 text-gray-200 p-4 text-center text-xl font-semibold tracking-wide border-b border-gray-700">
    SunYun's Mini Neurosynth Explorer
  </header>

  <!-- Main -->
  <main class="flex flex-col items-center p-8 space-y-8">
    
    <!-- Mode Switch -->
    <div class="flex space-x-4">
      <button id="termMode" class="px-4 py-2 rounded bg-gray-200 text-gray-900 font-medium hover:bg-gray-300 transition">
        Terms
      </button>
      <button id="studyMode" class="px-4 py-2 rounded bg-gray-800 text-gray-200 hover:bg-gray-700 transition">
        Studies
      </button>
    </div>

    <!-- Help Text -->
    <div id="helpText" class="text-gray-400 text-sm text-center max-w-md">
      🔍 輸入一個心理學或神經影像關鍵字，搜尋相關的 terms。
    </div>

    <!-- Search Bar -->
    <div class="w-full max-w-md flex space-x-2">
      <input id="searchInput" type="text" placeholder="Search..." 
        class="flex-1 bg-gray-800 text-gray-100 border border-gray-600 rounded p-2 focus:ring-2 focus:ring-gray-300 outline-none placeholder-gray-500">
      <button id="searchBtn" 
        class="bg-gray-200 text-gray-900 px-4 py-2 rounded hover:bg-gray-300 transition">
        Search
      </button>
    </div>

    <!-- Results -->
    <div id="resultContainer" class="w-full max-w-4xl bg-gray-900 rounded-lg shadow-lg p-4 border border-gray-700">
      <h2 id="resultTitle" class="text-lg font-semibold mb-3 text-gray-300 border-b border-gray-700 pb-2">Terms</h2>

      <!-- Table -->
      <table class="w-full text-left border-collapse">
        <thead id="tableHeader" class="border-b border-gray-700 text-gray-400 text-sm uppercase tracking-wider"></thead>
        <tbody id="resultList"></tbody>
      </table>
    </div>
  </main>

  <footer class="text-center text-gray-600 py-4 text-sm border-t border-gray-800">
    ⚙️ Powered by hpc.psy.ntu.edu.tw:5000 & TailwindCSS
  </footer>

  <script>
    const API_BASE = "https://hpc.psy.ntu.edu.tw:5000"
    let mode = "terms"
    let allItems = []
    let debounceTimer

    const termBtn = document.getElementById("termMode")
    const studyBtn = document.getElementById("studyMode")
    const searchInput = document.getElementById("searchInput")
    const searchBtn = document.getElementById("searchBtn")
    const resultList = document.getElementById("resultList")
    const resultTitle = document.getElementById("resultTitle")
    const tableHeader = document.getElementById("tableHeader")
    const helpText = document.getElementById("helpText")

    // Mode switch
    termBtn.onclick = () => switchMode("terms")
    studyBtn.onclick = () => switchMode("studies")

    function switchMode(m) {
      mode = m

      if (m === "terms") {
        termBtn.className = "px-4 py-2 rounded bg-gray-200 text-gray-900 font-medium hover:bg-gray-300 transition"
        studyBtn.className = "px-4 py-2 rounded bg-gray-800 text-gray-200 hover:bg-gray-700 transition"
        resultTitle.textContent = "Terms"
        helpText.innerHTML = "🔍 輸入一個心理學或神經影像關鍵字，搜尋相關的 terms。<br><small class='text-gray-500'>即時過濾 | 按 Enter 或 Search 查詢相關 terms</small>"
        tableHeader.innerHTML = `<tr><th class="p-2">Term</th></tr>`
        fetchTerms()
      } else {
        studyBtn.className = "px-4 py-2 rounded bg-gray-200 text-gray-900 font-medium hover:bg-gray-300 transition"
        termBtn.className = "px-4 py-2 rounded bg-gray-800 text-gray-200 hover:bg-gray-700 transition"
        resultTitle.textContent = "Studies"
        helpText.innerHTML = "📚 輸入關鍵字，即時搜尋相關研究的內容。"
        tableHeader.innerHTML = `<tr><th class="p-2 w-1/2">Title</th><th class="p-2">Authors</th><th class="p-2">Journal</th><th class="p-2">Year</th></tr>`
        fetchInitialStudies()
      }
      searchInput.value = ""
    }

    // Fetch terms from /terms
    async function fetchTerms() {
      resultList.innerHTML = "<tr><td class='p-2 text-gray-500'>Loading...</td></tr>"
      try {
        const res = await fetch(`${API_BASE}/terms`)
        if (!res.ok) throw new Error('Failed to fetch terms')
        const data = await res.json()
        allItems = Array.isArray(data) ? data : Object.keys(data)
        // Sort alphabetically and show first 10
        allItems.sort((a, b) => a.localeCompare(b))
        renderTerms(allItems.slice(0, 10))
      } catch (err) {
        resultList.innerHTML = `<tr><td class='p-2 text-red-400'>Error: ${err.message}</td></tr>`
      }
    }

    // Fetch initial studies (default query)
    async function fetchInitialStudies() {
      searchStudies('brain')
    }

    // Search studies from /query/<q>/studies
    async function searchStudies(query) {
      resultList.innerHTML = "<tr><td colspan='4' class='p-2 text-gray-500'>Loading...</td></tr>"
      try {
        const res = await fetch(`${API_BASE}/query/${encodeURIComponent(query)}/studies`)
        if (!res.ok) throw new Error('Failed to fetch studies')
        const data = await res.json()
        const studies = data.results || []
        renderStudies(studies.slice(0, 10))
      } catch (err) {
        resultList.innerHTML = `<tr><td colspan='4' class='p-2 text-red-400'>Error: ${err.message}</td></tr>`
      }
    }

    // Fetch related terms from /terms/<term>
    async function fetchRelatedTerms(term) {
      resultList.innerHTML = "<tr><td class='p-2 text-gray-500'>Loading related terms...</td></tr>"
      try {
        const res = await fetch(`${API_BASE}/terms/${encodeURIComponent(term)}`)
        if (!res.ok) throw new Error('Failed to fetch related terms')
        const data = await res.json()
        
        if (data && typeof data === 'object') {
          const relatedTerms = Object.keys(data)
          if (relatedTerms.length === 0) {
            resultList.innerHTML = "<tr><td class='p-2 text-gray-500 italic'>No related terms found.</td></tr>"
          } else {
            renderTerms(relatedTerms.slice(0, 20))
          }
        } else {
          resultList.innerHTML = "<tr><td class='p-2 text-gray-500 italic'>No related terms found.</td></tr>"
        }
      } catch (err) {
        resultList.innerHTML = `<tr><td class='p-2 text-red-400'>Error: ${err.message}</td></tr>`
      }
    }

    // Real-time search input - IMMEDIATE for terms, debounced for studies
    searchInput.addEventListener("input", e => {
      const query = e.target.value.toLowerCase().trim()
      
      if (mode === "terms") {
        // IMMEDIATE filtering for terms (no debounce)
        if (!query) {
          renderTerms(allItems.slice(0, 10))
        } else {
          const filtered = allItems.filter(i => i.toLowerCase().includes(query))
          renderTerms(filtered.slice(0, 10))
        }
      } else {
        // Debounced search for studies
        clearTimeout(debounceTimer)
        debounceTimer = setTimeout(() => {
          if (query) {
            searchStudies(query)
          } else {
            fetchInitialStudies()
          }
        }, 300)
      }
    })

    // Enter key or Search button
    searchInput.addEventListener("keypress", e => {
      if (e.key === "Enter") {
        doSearch()
      }
    })
    searchBtn.onclick = doSearch

    async function doSearch() {
      const q = searchInput.value.trim()
      if (!q) return

      if (mode === "terms") {
        // Fetch related terms
        fetchRelatedTerms(q)
      } else {
        // Search studies
        searchStudies(q)
      }
    }

    // Renderers
    function renderTerms(items) {
      if (!items || items.length === 0) {
        resultList.innerHTML = "<tr><td class='p-2 text-gray-500 italic'>No results.</td></tr>"
        return
      }
      resultList.innerHTML = items.map(i => `
        <tr class="hover:bg-gray-800 transition border-b border-gray-800 cursor-pointer" onclick="selectTerm('${i.replace(/'/g, "\\'")}')">
          <td class="p-2">${i}</td>
        </tr>
      `).join("")
    }

    function renderStudies(items) {
      if (!items || items.length === 0) {
        resultList.innerHTML = "<tr><td colspan='4' class='p-2 text-gray-500 italic'>No results.</td></tr>"
        return
      }
      resultList.innerHTML = items.map(s => `
        <tr class="hover:bg-gray-800 transition border-b border-gray-800">
          <td class="p-2 text-gray-100">${s.title || 'N/A'}</td>
          <td class="p-2 text-gray-400 text-sm">${s.authors || 'N/A'}</td>
          <td class="p-2 text-gray-400 text-sm">${s.journal || 'N/A'}</td>
          <td class="p-2 text-gray-400">${s.year || 'N/A'}</td>
        </tr>
      `).join("")
    }

    // Click on term to search related
    function selectTerm(term) {
      searchInput.value = term
      fetchRelatedTerms(term)
    }

    // Initial load
    switchMode("terms")
  </script>
</body>
</html>
